# ansible-playbook -i hosts  06_ha_apache_cluster.yml --ask-pass --ask-become-pass
# --ask-pass → SSH login password
# --ask-become-pass → sudo password
# Use --tags to run only a specific step, e.g.: 
# ansible-playbook -i hosts  06_ha_apache_cluster.yml --ask-pass --ask-become-pass --tags apache

#Refresh repos → ensures zypper metadata is up-to-date.
#Install cluster packages → pacemaker, corosync, crmsh, fence-agents, sbd.
#Install Apache → apache2.
#Enable and start Apache → ensures the service starts now and on boot. Create Apache test page
#Uses inventory_hostname so each node shows its own name in the test page.
#Open HTTP and HTTPS in firewall
#Tasks are tagged for modular execution (update, ha, apache, firewall, corosync, ha_services, crm, vip).
#inventory_hostname automatically inserts the node name into the test page.
#Corosync config is minimal for 2-node lab testing.
#STONITH is disabled for lab purposes; enable in production.
#The floating IP is optional; it moves with the active Apache node.

---
- name: "Step 1 & 2: Update nodes and install HA + Apache"
  hosts: suse_nodes
  become: yes
  tasks:

    - name: Refresh zypper repositories
      ansible.builtin.command:
        cmd: zypper refresh
      tags: update
      # Refresh repository metadata before upgrading/installing

    - name: Upgrade all packages to latest
      ansible.builtin.zypper:
        name: "*"
        state: latest
        update_cache: yes
      tags: update
      # Updates kernel and critical packages; reboot required manually if needed

    - name: Install HA cluster packages
      ansible.builtin.zypper:
        name:
          - pacemaker
          - corosync
          - crmsh
          - fence-agents
          - sbd
        state: present
        update_cache: yes
      tags: ha

    - name: Install Apache web server
      ansible.builtin.zypper:
        name: apache2
        state: present
        update_cache: yes
      tags: apache

    - name: Enable and start Apache
      ansible.builtin.service:
        name: apache2
        enabled: yes
        state: started
      tags: apache

    - name: Create Apache test page
      ansible.builtin.copy:
        dest: /srv/www/htdocs/index.html
        content: "<h1>Apache HA Test Node {{ inventory_hostname }}</h1>"
        owner: root
        group: root
        mode: '0644'
      tags: apache

- name: Step 3: Configure Firewall for Apache + Corosync
  hosts: suse_nodes
  become: yes
  tasks:
    - name: Allow HTTP and HTTPS
      ansible.builtin.command: firewall-cmd --zone=public --add-service={{ item }} --permanent
      loop:
        - http
        - https
      tags: firewall

    - name: Allow Corosync UDP ports
      ansible.builtin.command: firewall-cmd --zone=public --add-port={{ item }}/udp --permanent
      loop:
        - 5404
        - 5405
      tags: firewall

    - name: Reload firewall
      ansible.builtin.command: firewall-cmd --reload
      tags: firewall

- name: "Step 4: Configure /etc/hosts"
  hosts: suse_nodes
  become: yes
  tasks:
    - name: Ensure both nodes resolve each other
      ansible.builtin.copy:
        dest: /etc/hosts
        content: |
          10.0.2.154  node1
          10.0.2.155  node2
          127.0.0.1   localhost
          ::1         localhost
        owner: root
        group: root
        mode: '0644'
      tags: hosts

- name: "Step 5: Deploy Corosync configuration"
  hosts: suse_nodes
  become: yes
  tasks:
    - name: Copy corosync.conf
      ansible.builtin.copy:
        dest: /etc/corosync/corosync.conf
        content: |
          totem {
              version: 2
              secauth: off
              cluster_name: ha-test
              transport: udpu
              interface {
                  member {
                      memberaddr: 10.0.2.154
                  }
                  member {
                      memberaddr: 10.0.2.155
                  }
                  bindnetaddr: 10.0.2.0
              }
          }

          nodelist {
              node { ring0_addr: 10.0.2.154 name: node1 }
              node { ring0_addr: 10.0.2.155 name: node2 }
          }

          quorum {
              provider: corosync_votequorum
              two_node: 1
              wait_for_all: 1
          }
      tags: corosync

- name: "Step 6: Enable and start cluster services"
  hosts: suse_nodes
  become: yes
  tasks:
    - name: Enable and start corosync
      ansible.builtin.systemd:
        name: corosync
        state: started
        enabled: yes
      tags: ha_services

    - name: Enable and start pacemaker
      ansible.builtin.systemd:
        name: pacemaker
        state: started
        enabled: yes
      tags: ha_services

- name: "Step 7 & 8: Configure cluster properties and Apache resource"
  hosts: node1
  become: yes
  tasks:
    - name: Set cluster properties for lab environment
      ansible.builtin.command: >
        crm configure property stonith-enabled=false no-quorum-policy=ignore
      tags: crm

    - name: Set resource stickiness
      ansible.builtin.command: >
        crm configure rsc_defaults resource-stickiness=100
      tags: crm

    - name: Create Apache resource
      ansible.builtin.command: >
        crm configure primitive apache systemd:apache2
        op monitor interval=10s
      tags: crm

- name: "Step 9: Optional floating IP"
  hosts: node1
  become: yes
  tasks:
    - name: Create floating IP
      ansible.builtin.command: >
        crm configure primitive vip IPaddr2
        params ip=10.0.2.200 cidr_netmask=24 nic=eth0
      tags: vip

    - name: Colocate Apache with VIP
      ansible.builtin.command: >
        crm configure colocation col_apache_with_vip inf: apache vip
      tags: vip

    - name: Order Apache after VIP
      ansible.builtin.command: >
        crm configure order ord_apache_after_vip inf: vip apache
      tags: vip

- name: "Step 10-12: Verification and Failover (manual steps recommended)"
  hosts: suse_nodes
  become: yes
  tasks:
    - name: Display cluster status
      ansible.builtin.command: crm_mon -1
      register: cluster_status
      ignore_errors: yes
      tags: verify

    - name: Show cluster output
      ansible.builtin.debug:
        var: cluster_status.stdout
      tags: verify

